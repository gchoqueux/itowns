<!DOCTYPE html>
<html>
    <head>
        <title>Point Cloud Viewer</title>

        <style type="text/css">
            #info {
                color: #7ad7ff;
                font-family: 'Open Sans', sans-serif;
                position: absolute;
                top: 0;
                left: 0;
                padding: 0.3rem;
                background-color: #404040;
                z-index: 1;
            }
            @media (max-width: 600px) {
                #info,
                .dg {
                    display: none;
                }
            }
            .bubble {
                color:  #7ad7ff;
                font-family: 'Open Sans', sans-serif;
                background-color: #404040;
                border-radius: 10px;
                text-align: center;
                padding: 10px 15px;
                box-shadow: 0 0.125rem 0.5rem rgba(0, 0, 0, .3), 0 0.0625rem 0.125rem rgba(0, 0, 0, .2);
            }
            .pointer {
                height: 12px;
                width: 12px;
                background-color: #404040;
                transform: translate(-50%, -50%) rotate(45deg);
                position: relative;
                left: 80%;
            }
        </style>

        <meta charset="UTF-8">
        <link rel="stylesheet" type="text/css" href="css/example.css">
        <link rel="stylesheet" type="text/css" href="css/LoadingScreen.css">

        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
        <div id="viewerDiv">
            <div id="info"></div>
        </div>

        <div>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.6/dat.gui.min.js"></script>
            <script src="../dist/itowns.js"></script>
            <script src="js/GUI/LoadingScreen.js"></script>
            <script src="../dist/debug.js"></script>
            <script type="text/javascript">
                var potreeLayer;
                var oldPostUpdate;
                var viewerDiv;
                var debugGui;
                var view;
                var controls;
                var labelLayer;

                const customDiv = document.createElement('div');
                const bubble = document.createElement('div');
                bubble.classList.add('bubble');
                customDiv.appendChild(bubble);
                const pointer = document.createElement('div');
                pointer.classList.add('pointer');
                customDiv.appendChild(pointer);

                function createFeatureAt(coordinate) {
                    // create new featureCollection
                    const collection = new itowns.FeatureCollection({
                        crs: view.referenceCrs,
                        buildExtent: false,
                        structure: '3d',
                    });

                    // create new feature
                    const feature = collection.requestFeatureByType(itowns.FEATURE_TYPES.POINT);

                    // add geometries to feature
                    const geometry = feature.bindNewGeometry();
                    geometry.startSubGeometry(1, feature);
                    geometry.pushCoordinates(coordinate, feature);
                    geometry.properties.position = coordinate;

                    geometry.updateExtent();
                    feature.updateExtent(geometry);
                    collection.updateExtent(feature.extent);

                    return collection;
                }


                viewerDiv = document.getElementById('viewerDiv');
                viewerDiv.style.display = 'block';

                debugGui = new dat.GUI();

                itowns.proj4.defs("EPSG:2154","+proj=lcc +lat_1=49 +lat_2=44 +lat_0=46.5 +lon_0=3 +x_0=700000 +y_0=6600000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs");
                extent = new itowns.Extent('EPSG:2154',
                    831300, 831800,
                    6287500, 6287900);

            // `viewerDiv` will contain iTowns' rendering area (`<canvas>`)
                viewerDiv = document.getElementById('viewerDiv');

            // Instanciate PlanarView*
                view = new itowns.PlanarView(viewerDiv, extent, {
                    placement: {
                        coord : new itowns.Coordinates('EPSG:2154', 831620, 6287690),
                        heading: 43,
                        range: 115,
                        tilt: 28,
                    }});

                function setLabelContent(properties) {
                    const coord = properties.position.as('EPSG:4326');
                    bubble.textContent = `
                        lat : ${coord.y.toFixed(5)}° |
                        lon : ${coord.x.toFixed(5)}° |
                        alt : ${coord.z.toFixed(2)}m `;
                    return customDiv;
                }
                setupLoadingScreen(viewerDiv, view);
                view.mainLoop.gfxEngine.renderer.setClearColor(0x555555);
                view.tileLayer.object3d.position.z = 23;
                view.tileLayer.opacity = 0.001;

                // Configure Point Cloud layer
                potreeLayer = new itowns.PotreeLayer('eglise_saint_blaise_arles', {
                    source: new itowns.PotreeSource({
                        file: 'eglise_saint_blaise_arles.js',
                        url: 'https://raw.githubusercontent.com/iTowns/iTowns2-sample-data/master/pointclouds/eglise_saint_blaise_arles',
                        crs: view.referenceCrs,
                    }),
                });
                var v = new itowns.THREE.Vector3();

                const coord2154 = new itowns.Coordinates('EPSG:2154', 0, 0, 0);
                const coord4326 = new itowns.Coordinates('EPSG:4326', 0, 0, 0);

                let id = 0;

                // point selection on double-click
                function dblClickHandler(event) {
                    // const llabel = view.getLayerById('idLabelLayer');
                    if (view.getLayerById('idLabelLayer')) {
                        view.removeLayer('idLabelLayer');
                    }

                    var p = view.pickObjectsAt(event, 2, potreeLayer)[0];

                    if (!p) {
                        return;
                    }

                    const arrayPositions = p.object.geometry.attributes.position.array;

                    v.fromArray(arrayPositions, p.index * 3).applyMatrix4(p.object.matrixWorld);

                    coord2154.setFromVector3(v);

                    const features = createFeatureAt(coord2154);
                    // the source of the feature layer
                    const source = new itowns.FileSource({ features });
                    // create labelLayer
                    labelLayer = new itowns.LabelLayer('idLabelLayer', {
                        source: source,
                        domElement: setLabelContent,
                        style: new itowns.Style({
                            zoom: {
                                min: 0,
                                max: 20,
                            },
                            text: { anchor: [-0.8, -1] },
                        }),
                    });

                    view.addLayer(labelLayer);
                }
                view.domElement.addEventListener('dblclick', dblClickHandler);

                // add potreeLayer to scene
                function onLayerReady() {
                    // update stats window
                    var info = document.getElementById('info');
                    view.addFrameRequester(itowns.MAIN_LOOP_EVENTS.AFTER_RENDER, () => {
                        info.textContent = potreeLayer.displayedCount.toLocaleString() + ' points';
                    });
                }

                window.view = view;
                itowns.View.prototype.addLayer.call(view, potreeLayer).then(onLayerReady);
            </script>
    </body>
</html>

